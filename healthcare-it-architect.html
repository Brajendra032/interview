<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Healthcare IT Architect Interview Guide - Full Stack Developer Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-content">
            <a href="index.html" class="nav-brand">
                <i class="fas fa-code"></i>
                Interview Prep
            </a>
            <div class="nav-links">
                <a href="#compliance" class="nav-link">Compliance</a>
                <a href="#integration" class="nav-link">Integration</a>
                <a href="#architecture" class="nav-link">Architecture</a>
                <a href="#security" class="nav-link">Security</a>
                <a href="index.html" class="back-button">‚Üê Back</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">üè• Healthcare IT Architect Interview Guide</h1>
                <p class="hero-subtitle">
                    Master HIPAA, HL7, FHIR, and Healthcare System Architecture
                </p>

                <div class="hero-stats">
                    <div class="stat-item">
                        <span class="stat-number">35+</span>
                        <span class="stat-label">Questions</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">15+</span>
                        <span class="stat-label">Standards</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">20+</span>
                        <span class="stat-label">Code Examples</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">100%</span>
                        <span class="stat-label">Healthcare Focused</span>
                    </div>
                </div>
            </div>
        </section>

        <div class="content">
            <!-- Code Modal -->
            <div id="codeModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle" class="modal-title">Code Example</h2>
                        <button class="modal-close" onclick="closeCodeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="modalCode" class="code-modal-content" data-lang="javascript"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <i class="fas fa-shield-alt section-icon"></i>
                    <div>
                        <h2 class="section-title">üîí HIPAA Compliance & Security</h2>
                        <p class="section-description">Master healthcare data protection, privacy regulations, and compliance frameworks</p>
                    </div>
                </div>

                <div class="question-grid">
                    <div class="question-card fade-in-up">
                        <div class="question-header">
                            <div class="question-number">1</div>
                            <h3 class="question-title">HIPAA Security Rule Implementation</h3>
                        </div>
                        <div class="question-meta">
                            <span class="question-badge">Compliance</span>
                            <span class="question-badge">Security</span>
                            <span class="question-badge">HIPAA</span>
                        </div>
                        <div class="question-content">
                            <p>Design and implement a comprehensive HIPAA Security Rule compliance framework for a healthcare application.</p>

                            <div class="highlight-box danger">
                                <div class="highlight-header">
                                    <i class="fas fa-lock highlight-icon"></i>
                                    <strong>HIPAA Security Rule Components:</strong>
                                </div>
                                <ul>
                                    <li><strong>Administrative Safeguards:</strong> Security management, workforce training, evaluation</li>
                                    <li><strong>Physical Safeguards:</strong> Facility access, workstation security, device security</li>
                                    <li><strong>Technical Safeguards:</strong> Access control, audit controls, integrity, transmission security</li>
                                    <li><strong>Organizational Requirements:</strong> Business associate agreements, group health plans</li>
                                </ul>
                            </div>
                        </div>

                        <button class="code-toggle-btn">
                            <i class="fas fa-code"></i> View Code Example
                        </button>

                        <div class="code-block" data-lang="javascript" data-title="HIPAA Security Framework">
// HIPAA Security Rule Implementation Framework

class HIPAAComplianceManager {
    constructor(options = {}) {
        this.organization = options.organization;
        this.securityOfficer = options.securityOfficer;
        this.riskAssessments = [];
        this.policies = new Map();
        this.incidents = [];
        this.auditLogs = [];

        // Initialize security controls
        this.initializeSecurityControls();
        this.setupAuditLogging();
        this.configureAccessControls();
    }

    // Administrative Safeguards
    async conductRiskAssessment() {
        const assessment = {
            id: uuidv4(),
            date: new Date(),
            scope: 'organization-wide',
            findings: [],
            recommendations: [],
            status: 'in-progress'
        };

        // Identify threats and vulnerabilities
        const threats = await this.identifyThreats();
        const vulnerabilities = await this.assessVulnerabilities();

        assessment.findings = this.analyzeRisks(threats, vulnerabilities);
        assessment.recommendations = this.generateRecommendations(assessment.findings);

        this.riskAssessments.push(assessment);
        return assessment;
    }

    async identifyThreats() {
        return [
            'Unauthorized access',
            'Data breaches',
            'Malware infections',
            'Physical theft',
            'Natural disasters',
            'Insider threats',
            'Third-party vendor risks'
        ];
    }

    async assessVulnerabilities() {
        const vulnerabilities = [];

        // Check encryption implementation
        if (!await this.checkEncryptionCompliance()) {
            vulnerabilities.push({
                type: 'encryption',
                severity: 'high',
                description: 'PHI data not properly encrypted at rest and in transit'
            });
        }

        // Check access controls
        if (!await this.checkAccessControls()) {
            vulnerabilities.push({
                type: 'access_control',
                severity: 'critical',
                description: 'Insufficient access controls for PHI data'
            });
        }

        // Check audit logging
        if (!await this.checkAuditLogging()) {
            vulnerabilities.push({
                type: 'audit',
                severity: 'high',
                description: 'Inadequate audit logging for security events'
            });
        }

        return vulnerabilities;
    }

    // Physical Safeguards
    async implementFacilityAccessControls() {
        const controls = {
            biometricAccess: true,
            visitorLogging: true,
            serverRoomSecurity: true,
            deviceTracking: true
        };

        // Implement automated access logging
        this.setupFacilityMonitoring(controls);

        return controls;
    }

    // Technical Safeguards
    async implementAccessControls() {
        const accessControl = {
            roleBasedAccess: true,
            minimumNecessaryAccess: true,
            emergencyAccess: false,
            automaticLogoff: true,
            sessionTimeout: 15, // minutes
            uniqueUserIdentification: true,
            passwordRequirements: {
                minLength: 12,
                complexity: true,
                history: 5,
                expiration: 90 // days
            }
        };

        // Implement role-based permissions
        this.setupRBAC(accessControl);

        return accessControl;
    }

    async implementAuditControls() {
        const auditConfig = {
            logAllAccess: true,
            logModifications: true,
            logDeletions: true,
            logEmergencyAccess: true,
            logFailedAccess: true,
            retainLogs: 6, // years
            reviewFrequency: 'monthly',
            automatedAlerts: true
        };

        // Setup comprehensive logging
        this.configureAuditLogging(auditConfig);

        return auditConfig;
    }

    async implementDataIntegrity() {
        const integrityControls = {
            dataValidation: true,
            checksumVerification: true,
            backupVerification: true,
            changeDetection: true,
            encryptionValidation: true
        };

        // Implement integrity verification
        this.setupIntegrityChecks(integrityControls);

        return integrityControls;
    }

    async implementTransmissionSecurity() {
        const transmissionSecurity = {
            tlsEncryption: '1.3',
            vpnRequired: true,
            secureEmail: true,
            secureFileTransfer: true,
            endpointVerification: true
        };

        // Configure secure transmission
        this.setupSecureTransmission(transmissionSecurity);

        return transmissionSecurity;
    }

    // Incident Response
    async handleSecurityIncident(incident) {
        const incidentRecord = {
            id: uuidv4(),
            type: incident.type,
            severity: incident.severity,
            description: incident.description,
            discovered: new Date(),
            reported: null,
            contained: null,
            resolved: null,
            affectedSystems: incident.affectedSystems,
            affectedPHI: incident.affectedPHI,
            actions: [],
            lessonsLearned: null
        };

        this.incidents.push(incidentRecord);

        // Notify required parties
        await this.notifyIncidentResponseTeam(incidentRecord);

        // Execute response plan
        await this.executeIncidentResponse(incidentRecord);

        return incidentRecord;
    }

    // Business Associate Agreements
    async manageBusinessAssociate(associate) {
        const agreement = {
            associateId: associate.id,
            agreementDate: new Date(),
            services: associate.services,
            dataShared: associate.dataTypes,
            securityRequirements: associate.securityRequirements,
            monitoringRequired: true,
            terminationClauses: true
        };

        // Validate associate compliance
        await this.validateAssociateCompliance(associate);

        return agreement;
    }

    // Compliance Monitoring
    async generateComplianceReport() {
        const report = {
            period: 'monthly',
            date: new Date(),
            riskAssessments: this.riskAssessments.slice(-12), // Last 12 months
            incidents: this.incidents.filter(i => i.discovered >= this.getLastMonth()),
            auditFindings: await this.getAuditFindings(),
            correctiveActions: await this.getCorrectiveActions(),
            complianceStatus: await this.calculateComplianceScore()
        };

        return report;
    }

    async calculateComplianceScore() {
        const weights = {
            administrativeSafeguards: 0.3,
            physicalSafeguards: 0.2,
            technicalSafeguards: 0.3,
            incidentResponse: 0.1,
            continuousMonitoring: 0.1
        };

        const scores = {
            administrativeSafeguards: await this.scoreAdministrativeSafeguards(),
            physicalSafeguards: await this.scorePhysicalSafeguards(),
            technicalSafeguards: await this.scoreTechnicalSafeguards(),
            incidentResponse: await this.scoreIncidentResponse(),
            continuousMonitoring: await this.scoreContinuousMonitoring()
        };

        return Object.entries(weights).reduce((total, [key, weight]) =>
            total + (scores[key] * weight), 0);
    }

    // Helper methods
    async checkEncryptionCompliance() {
        // Check if all PHI data stores are encrypted
        // Check if data in transit uses TLS 1.3+
        // Check if encryption keys are properly managed
        return true; // Implementation would check actual systems
    }

    async checkAccessControls() {
        // Verify RBAC implementation
        // Check minimum necessary access
        // Validate session management
        return true;
    }

    async checkAuditLogging() {
        // Verify audit logs capture all required events
        // Check log retention and protection
        // Validate log review processes
        return true;
    }

    setupFacilityMonitoring(controls) {
        // Implement facility access monitoring
        console.log('Facility monitoring configured:', controls);
    }

    setupRBAC(accessControl) {
        // Implement role-based access control
        console.log('RBAC configured:', accessControl);
    }

    configureAuditLogging(auditConfig) {
        // Setup audit logging system
        console.log('Audit logging configured:', auditConfig);
    }

    setupIntegrityChecks(integrityControls) {
        // Implement data integrity checks
        console.log('Integrity checks configured:', integrityControls);
    }

    setupSecureTransmission(transmissionSecurity) {
        // Configure secure data transmission
        console.log('Secure transmission configured:', transmissionSecurity);
    }

    async notifyIncidentResponseTeam(incident) {
        // Send notifications to incident response team
        console.log('Incident response team notified:', incident.id);
    }

    async executeIncidentResponse(incident) {
        // Execute predefined incident response procedures
        console.log('Incident response executed for:', incident.id);
    }

    async validateAssociateCompliance(associate) {
        // Validate business associate security practices
        console.log('Associate compliance validated:', associate.id);
    }

    getLastMonth() {
        const date = new Date();
        date.setMonth(date.getMonth() - 1);
        return date;
    }

    async getAuditFindings() {
        // Retrieve recent audit findings
        return [];
    }

    async getCorrectiveActions() {
        // Get status of corrective actions
        return [];
    }

    async scoreAdministrativeSafeguards() { return 0.85; }
    async scorePhysicalSafeguards() { return 0.90; }
    async scoreTechnicalSafeguards() { return 0.80; }
    async scoreIncidentResponse() { return 0.75; }
    async scoreContinuousMonitoring() { return 0.88; }
}

// Usage example
const hipaaManager = new HIPAAComplianceManager({
    organization: 'Medical Center Inc.',
    securityOfficer: 'Jane Smith'
});

// Conduct risk assessment
hipaaManager.conductRiskAssessment().then(assessment => {
    console.log('Risk assessment completed:', assessment.id);
});

// Handle security incident
const incident = {
    type: 'data_breach',
    severity: 'high',
    description: 'Unauthorized access to patient records',
    affectedSystems: ['EHR', 'Patient Portal'],
    affectedPHI: ['names', 'addresses', 'medical_records']
};

hipaaManager.handleSecurityIncident(incident).then(record => {
    console.log('Incident handled:', record.id);
});
                        </div>
                    </div>

                    <div class="question-card fade-in-up">
                        <div class="question-header">
                            <div class="question-number">2</div>
                            <h3 class="question-title">HL7 FHIR Implementation</h3>
                        </div>
                        <div class="question-meta">
                            <span class="question-badge">Integration</span>
                            <span class="question-badge">Standards</span>
                            <span class="question-badge">HL7</span>
                        </div>
                        <div class="question-content">
                            <p>Design and implement HL7 FHIR-based healthcare data exchange between systems.</p>

                            <div class="highlight-box success">
                                <div class="highlight-header">
                                    <i class="fas fa-exchange-alt highlight-icon"></i>
                                    <strong>FHIR Benefits:</strong>
                                </div>
                                <ul>
                                    <li>Standardized healthcare data representation</li>
                                    <li>RESTful APIs for interoperability</li>
                                    <li>Extensible resource model</li>
                                    <li>Improved clinical workflows</li>
                                    <li>Better patient outcomes through data sharing</li>
                                </ul>
                            </div>
                        </div>

                        <button class="code-toggle-btn">
                            <i class="fas fa-code"></i> View Code Example
                        </button>

                        <div class="code-block" data-lang="javascript" data-title="HL7 FHIR Implementation">
// HL7 FHIR Implementation

class FHIRServer {
    constructor(baseUrl = 'http://localhost:8080/fhir') {
        this.baseUrl = baseUrl;
        this.resources = new Map();
        this.searchParameters = new Map();
        this.capabilityStatement = this.createCapabilityStatement();
    }

    // Resource Management
    async createResource(resourceType, resource) {
        // Validate resource against FHIR profile
        await this.validateResource(resourceType, resource);

        // Generate resource ID if not provided
        if (!resource.id) {
            resource.id = uuidv4();
        }

        // Set metadata
        resource.meta = {
            versionId: '1',
            lastUpdated: new Date().toISOString(),
            ...resource.meta
        };

        // Store resource
        const key = `${resourceType}/${resource.id}`;
        this.resources.set(key, resource);

        return {
            resource,
            status: 201,
            location: `${this.baseUrl}/${key}`
        };
    }

    async readResource(resourceType, id) {
        const key = `${resourceType}/${id}`;
        const resource = this.resources.get(key);

        if (!resource) {
            throw new Error(`Resource ${key} not found`);
        }

        return resource;
    }

    async updateResource(resourceType, id, resource) {
        const key = `${resourceType}/${id}`;
        const existing = this.resources.get(key);

        if (!existing) {
            throw new Error(`Resource ${key} not found`);
        }

        // Validate update
        await this.validateResource(resourceType, resource);

        // Update metadata
        resource.meta = {
            ...existing.meta,
            versionId: (parseInt(existing.meta.versionId) + 1).toString(),
            lastUpdated: new Date().toISOString()
        };

        this.resources.set(key, resource);
        return resource;
    }

    async deleteResource(resourceType, id) {
        const key = `${resourceType}/${id}`;
        if (!this.resources.has(key)) {
            throw new Error(`Resource ${key} not found`);
        }

        this.resources.delete(key);
        return { status: 204 };
    }

    // Search Operations
    async searchResources(resourceType, searchParams) {
        let results = Array.from(this.resources.entries())
            .filter(([key]) => key.startsWith(`${resourceType}/`))
            .map(([, resource]) => resource);

        // Apply search parameters
        for (const [param, value] of Object.entries(searchParams)) {
            results = results.filter(resource =>
                this.matchesSearchParameter(resource, param, value)
            );
        }

        return {
            resourceType: 'Bundle',
            type: 'searchset',
            total: results.length,
            entry: results.map(resource => ({
                resource,
                search: { mode: 'match' }
            }))
        };
    }

    matchesSearchParameter(resource, param, value) {
        switch (param) {
            case 'name':
                return resource.name &&
                       resource.name.some(name =>
                           name.family?.toLowerCase().includes(value.toLowerCase()) ||
                           name.given?.some(given => given.toLowerCase().includes(value.toLowerCase()))
                       );
            case 'identifier':
                return resource.identifier &&
                       resource.identifier.some(id => id.value === value);
            case 'birthdate':
                return resource.birthDate === value;
            case 'gender':
                return resource.gender === value;
            default:
                return true;
        }
    }

    // Validation
    async validateResource(resourceType, resource) {
        // Basic FHIR resource validation
        if (!resource.resourceType || resource.resourceType !== resourceType) {
            throw new Error('Invalid resource type');
        }

        // Validate required fields based on resource type
        switch (resourceType) {
            case 'Patient':
                this.validatePatient(resource);
                break;
            case 'Observation':
                this.validateObservation(resource);
                break;
            case 'Condition':
                this.validateCondition(resource);
                break;
        }
    }

    validatePatient(patient) {
        if (!patient.name || patient.name.length === 0) {
            throw new Error('Patient must have at least one name');
        }
    }

    validateObservation(observation) {
        if (!observation.subject) {
            throw new Error('Observation must have a subject');
        }
        if (!observation.code) {
            throw new Error('Observation must have a code');
        }
        if (!observation.valueQuantity && !observation.valueCodeableConcept) {
            throw new Error('Observation must have a value');
        }
    }

    validateCondition(condition) {
        if (!condition.subject) {
            throw new Error('Condition must have a subject');
        }
        if (!condition.code) {
            throw new Error('Condition must have a code');
        }
    }

    // FHIR Operations
    async patientEverything(patientId) {
        // Get all resources related to a patient
        const patient = await this.readResource('Patient', patientId);

        const relatedResources = [];

        // Get all observations for this patient
        const observations = await this.searchResources('Observation', {
            subject: `Patient/${patientId}`
        });
        relatedResources.push(...observations.entry);

        // Get all conditions
        const conditions = await this.searchResources('Condition', {
            subject: `Patient/${patientId}`
        });
        relatedResources.push(...conditions.entry);

        // Get all encounters
        const encounters = await this.searchResources('Encounter', {
            subject: `Patient/${patientId}`
        });
        relatedResources.push(...encounters.entry);

        return {
            resourceType: 'Bundle',
            type: 'searchset',
            entry: relatedResources
        };
    }

    createCapabilityStatement() {
        return {
            resourceType: 'CapabilityStatement',
            status: 'active',
            date: new Date().toISOString(),
            kind: 'instance',
            software: {
                name: 'FHIR Server',
                version: '1.0.0'
            },
            implementation: {
                description: 'Healthcare FHIR Server Implementation'
            },
            rest: [{
                mode: 'server',
                resource: [
                    {
                        type: 'Patient',
                        interaction: [
                            { code: 'read' },
                            { code: 'search-type' },
                            { code: 'create' },
                            { code: 'update' }
                        ],
                        searchParam: [
                            { name: 'name', type: 'string' },
                            { name: 'identifier', type: 'token' },
                            { name: 'birthdate', type: 'date' },
                            { name: 'gender', type: 'token' }
                        ]
                    },
                    {
                        type: 'Observation',
                        interaction: [
                            { code: 'read' },
                            { code: 'search-type' },
                            { code: 'create' }
                        ]
                    }
                ]
            }]
        };
    }
}

// FHIR Client
class FHIRClient {
    constructor(serverUrl) {
        this.serverUrl = serverUrl;
    }

    async createPatient(patientData) {
        const patient = {
            resourceType: 'Patient',
            ...patientData
        };

        return await this.post('Patient', patient);
    }

    async getPatient(id) {
        return await this.get(`Patient/${id}`);
    }

    async searchPatients(searchParams) {
        return await this.get('Patient', searchParams);
    }

    async createObservation(observationData) {
        const observation = {
            resourceType: 'Observation',
            ...observationData
        };

        return await this.post('Observation', observation);
    }

    async getPatientSummary(patientId) {
        return await this.get(`Patient/${patientId}/$everything`);
    }

    async get(url, params = {}) {
        const queryString = new URLSearchParams(params).toString();
        const fullUrl = queryString ? `${this.serverUrl}/${url}?${queryString}` : `${this.serverUrl}/${url}`;

        const response = await fetch(fullUrl);
        if (!response.ok) {
            throw new Error(`FHIR request failed: ${response.status}`);
        }

        return await response.json();
    }

    async post(resourceType, resource) {
        const response = await fetch(`${this.serverUrl}/${resourceType}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(resource)
        });

        if (!response.ok) {
            throw new Error(`FHIR create failed: ${response.status}`);
        }

        return await response.json();
    }
}

// Usage example
const server = new FHIRServer();
const client = new FHIRClient('http://localhost:8080/fhir');

// Create a patient
const patientData = {
    name: [{
        family: 'Doe',
        given: ['John']
    }],
    gender: 'male',
    birthDate: '1980-01-01',
    identifier: [{
        system: 'http://hospital.org/patient-id',
        value: '12345'
    }]
};

client.createPatient(patientData).then(result => {
    console.log('Patient created:', result.resource.id);

    // Create an observation for this patient
    const observationData = {
        subject: { reference: `Patient/${result.resource.id}` },
        code: {
            coding: [{
                system: 'http://loinc.org',
                code: '8480-6',
                display: 'Systolic blood pressure'
            }]
        },
        valueQuantity: {
            value: 120,
            unit: 'mmHg',
            system: 'http://unitsofmeasure.org',
            code: 'mm[Hg]'
        },
        effectiveDateTime: new Date().toISOString()
    };

    return client.createObservation(observationData);
}).then(result => {
    console.log('Observation created:', result.resource.id);
}).catch(error => {
    console.error('Error:', error);
});
                        </div>
                    </div>

                    <div class="question-card fade-in-up">
                        <div class="question-header">
                            <div class="question-number">3</div>
                            <h3 class="question-title">OpenEMR Architecture & Customization</h3>
                        </div>
                        <div class="question-meta">
                            <span class="question-badge">Architecture</span>
                            <span class="question-badge">OpenEMR</span>
                            <span class="question-badge">EHR</span>
                        </div>
                        <div class="question-content">
                            <p>Design scalable OpenEMR architecture with custom modules and integrations.</p>

                            <div class="highlight-box info">
                                <div class="highlight-header">
                                    <i class="fas fa-hospital highlight-icon"></i>
                                    <strong>OpenEMR Architecture:</strong>
                                </div>
                                <ul>
                                    <li><strong>Core Modules:</strong> Patient management, scheduling, billing, clinical notes</li>
                                    <li><strong>Extensibility:</strong> Custom forms, reports, and workflows</li>
                                    <li><strong>Integration:</strong> HL7, FHIR, laboratory systems</li>
                                    <li><strong>Security:</strong> HIPAA compliance, access controls, audit trails</li>
                                </ul>
                            </div>
                        </div>

                        <button class="code-toggle-btn">
                            <i class="fas fa-code"></i> View Code Example
                        </button>

                        <div class="code-block" data-lang="php" data-title="OpenEMR Custom Module Architecture">
<?php
/**
 * OpenEMR Custom Module Architecture
 * Advanced healthcare management system with custom modules
 */

// Custom Module Base Class
abstract class OpenEMRCustomModule {
    protected $moduleName;
    protected $version;
    protected $dependencies = [];

    public function __construct() {
        $this->initializeModule();
    }

    abstract protected function initializeModule();
    abstract public function getModuleInfo();
    abstract public function install();
    abstract public function uninstall();
    abstract public function upgrade($fromVersion);

    protected function registerHooks() {
        // Register module hooks with OpenEMR core
        $hooks = $this->getHooks();
        foreach ($hooks as $hook => $callback) {
            registerHook($hook, [$this, $callback]);
        }
    }

    protected function getHooks() {
        return [];
    }

    protected function addMenuItem($menu, $title, $url, $parent = null) {
        // Add menu item to OpenEMR navigation
        $menuItem = [
            'title' => $title,
            'url' => $url,
            'parent' => $parent,
            'module' => $this->moduleName
        ];

        addToMenu($menu, $menuItem);
    }
}

// Advanced Telemedicine Module
class TelemedicineModule extends OpenEMRCustomModule {
    protected $moduleName = 'telemedicine';
    protected $version = '2.0.0';

    protected function initializeModule() {
        $this->dependencies = ['video', 'messaging', 'calendar'];
        $this->registerHooks();
        $this->setupDatabaseTables();
        $this->configureVideoIntegration();
    }

    public function getModuleInfo() {
        return [
            'name' => 'Advanced Telemedicine',
            'description' => 'Complete telemedicine solution with video calls, scheduling, and integration',
            'version' => $this->version,
            'author' => 'Healthcare Tech Team',
            'license' => 'GPLv3'
        ];
    }

    public function install() {
        // Create database tables
        $this->createTelemedicineTables();

        // Register menu items
        $this->addMenuItem('main', 'Telemedicine', 'telemedicine/dashboard.php');
        $this->addMenuItem('telemedicine', 'Schedule Appointment', 'telemedicine/schedule.php');
        $this->addMenuItem('telemedicine', 'Video Calls', 'telemedicine/calls.php');
        $this->addMenuItem('telemedicine', 'Settings', 'telemedicine/settings.php');

        // Set up permissions
        $this->setupPermissions();

        return true;
    }

    public function uninstall() {
        // Remove database tables
        $this->dropTelemedicineTables();

        // Remove menu items
        removeFromMenu('telemedicine');

        // Clean up permissions
        $this->removePermissions();

        return true;
    }

    public function upgrade($fromVersion) {
        switch ($fromVersion) {
            case '1.0.0':
                $this->upgradeFrom100();
                break;
            case '1.5.0':
                $this->upgradeFrom150();
                break;
        }

        return true;
    }

    protected function getHooks() {
        return [
            'patient.before_save' => 'onPatientSave',
            'appointment.created' => 'onAppointmentCreated',
            'encounter.completed' => 'onEncounterCompleted'
        ];
    }

    public function onPatientSave($patientData) {
        // Validate telemedicine eligibility
        if ($this->isTelemedicineEligible($patientData)) {
            $this->updatePatientTelemedicineStatus($patientData['id'], true);
        }
    }

    public function onAppointmentCreated($appointmentData) {
        // If telemedicine appointment, set up video call
        if ($appointmentData['type'] === 'telemedicine') {
            $this->scheduleVideoCall($appointmentData);
        }
    }

    public function onEncounterCompleted($encounterData) {
        // Generate telemedicine summary
        if ($encounterData['telemedicine']) {
            $this->generateTelemedicineSummary($encounterData);
        }
    }

    private function setupDatabaseTables() {
        // Create telemedicine-specific tables
        sqlQuery("
            CREATE TABLE IF NOT EXISTS telemedicine_sessions (
                id INT PRIMARY KEY AUTO_INCREMENT,
                patient_id INT NOT NULL,
                provider_id INT NOT NULL,
                appointment_id INT,
                session_id VARCHAR(255) UNIQUE NOT NULL,
                start_time DATETIME,
                end_time DATETIME,
                status ENUM('scheduled', 'in_progress', 'completed', 'cancelled') DEFAULT 'scheduled',
                recording_url VARCHAR(500),
                notes TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                FOREIGN KEY (patient_id) REFERENCES patient_data(id),
                FOREIGN KEY (provider_id) REFERENCES users(id),
                FOREIGN KEY (appointment_id) REFERENCES openemr_postcalendar_events(pc_eid)
            )
        ");

        sqlQuery("
            CREATE TABLE IF NOT EXISTS telemedicine_settings (
                id INT PRIMARY KEY AUTO_INCREMENT,
                setting_key VARCHAR(100) UNIQUE NOT NULL,
                setting_value TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
            )
        ");
    }

    private function createTelemedicineTables() {
        // Additional tables for telemedicine functionality
        sqlQuery("
            CREATE TABLE telemedicine_waiting_room (
                id INT PRIMARY KEY AUTO_INCREMENT,
                session_id INT NOT NULL,
                patient_id INT NOT NULL,
                joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                status ENUM('waiting', 'admitted', 'left') DEFAULT 'waiting',
                FOREIGN KEY (session_id) REFERENCES telemedicine_sessions(id),
                FOREIGN KEY (patient_id) REFERENCES patient_data(id)
            )
        ");
    }

    private function configureVideoIntegration() {
        // Configure video calling integration (Zoom, Twilio, etc.)
        $videoConfig = [
            'provider' => 'zoom', // or 'twilio', 'agora'
            'api_key' => getenv('VIDEO_API_KEY'),
            'api_secret' => getenv('VIDEO_API_SECRET'),
            'webhook_url' => $GLOBALS['webroot'] . '/interface/modules/telemedicine/webhook.php'
        ];

        $this->saveSetting('video_config', json_encode($videoConfig));
    }

    private function setupPermissions() {
        // Create telemedicine-specific permissions
        $permissions = [
            'telemedicine_appointments' => 'Schedule telemedicine appointments',
            'telemedicine_calls' => 'Conduct video calls',
            'telemedicine_admin' => 'Administer telemedicine settings',
            'telemedicine_reports' => 'View telemedicine reports'
        ];

        foreach ($permissions as $permission => $description) {
            createPermission($permission, $description);
        }
    }

    private function isTelemedicineEligible($patientData) {
        // Check if patient is eligible for telemedicine
        // Based on location, insurance, medical conditions, etc.
        return true; // Simplified logic
    }

    private function scheduleVideoCall($appointmentData) {
        // Schedule video call with video provider
        $videoService = $this->getVideoService();

        $meetingDetails = $videoService->createMeeting([
            'topic' => 'Telemedicine Consultation',
            'start_time' => $appointmentData['start_time'],
            'duration' => $appointmentData['duration']
        ]);

        // Save meeting details to database
        sqlQuery("
            UPDATE telemedicine_sessions
            SET session_id = ?, start_time = ?
            WHERE appointment_id = ?
        ", [$meetingDetails['meeting_id'], $appointmentData['start_time'], $appointmentData['pc_eid']]);
    }

    private function generateTelemedicineSummary($encounterData) {
        // Generate summary report for telemedicine encounter
        $summary = [
            'encounter_id' => $encounterData['id'],
            'patient_id' => $encounterData['patient_id'],
            'provider_id' => $encounterData['provider_id'],
            'duration' => $encounterData['duration'],
            'diagnosis' => $encounterData['diagnosis'],
            'treatment_plan' => $encounterData['treatment_plan'],
            'follow_up_required' => $encounterData['follow_up'],
            'generated_at' => date('Y-m-d H:i:s')
        ];

        // Save summary and send to patient
        $this->saveTelemedicineSummary($summary);
        $this->sendSummaryToPatient($summary);
    }

    private function saveSetting($key, $value) {
        sqlQuery("
            INSERT INTO telemedicine_settings (setting_key, setting_value)
            VALUES (?, ?)
            ON DUPLICATE KEY UPDATE setting_value = VALUES(setting_value)
        ", [$key, $value]);
    }

    private function getVideoService() {
        // Factory method for video service
        $config = json_decode($this->getSetting('video_config'), true);

        switch ($config['provider']) {
            case 'zoom':
                return new ZoomVideoService($config);
            case 'twilio':
                return new TwilioVideoService($config);
            default:
                throw new Exception('Unsupported video provider');
        }
    }

    private function getSetting($key) {
        $result = sqlQuery("SELECT setting_value FROM telemedicine_settings WHERE setting_key = ?", [$key]);
        return $result ? $result['setting_value'] : null;
    }
}

// Advanced Reporting Module
class HealthcareReportingModule extends OpenEMRCustomModule {
    protected $moduleName = 'healthcare_reporting';
    protected $version = '1.0.0';

    protected function initializeModule() {
        $this->dependencies = ['reporting', 'analytics'];
        $this->registerHooks();
        $this->setupReportingTables();
    }

    public function getModuleInfo() {
        return [
            'name' => 'Healthcare Advanced Reporting',
            'description' => 'Comprehensive healthcare analytics and reporting system',
            'version' => $this->version,
            'author' => 'Healthcare Analytics Team',
            'license' => 'GPLv3'
        ];
    }

    public function install() {
        $this->createReportingTables();
        $this->setupReportTemplates();
        $this->addMenuItem('reports', 'Healthcare Analytics', 'reports/healthcare-analytics.php');

        return true;
    }

    public function uninstall() {
        $this->dropReportingTables();
        removeFromMenu('healthcare_reporting');

        return true;
    }

    public function upgrade($fromVersion) {
        // Upgrade logic
        return true;
    }

    private function setupReportingTables() {
        // Create tables for advanced reporting
        sqlQuery("
            CREATE TABLE IF NOT EXISTS healthcare_metrics (
                id INT PRIMARY KEY AUTO_INCREMENT,
                metric_name VARCHAR(100) NOT NULL,
                metric_value DECIMAL(10,2),
                metric_date DATE NOT NULL,
                category VARCHAR(50),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                INDEX idx_metric_date (metric_date),
                INDEX idx_category (category)
            )
        ");
    }

    private function createReportingTables() {
        // Additional reporting tables
        sqlQuery("
            CREATE TABLE report_schedules (
                id INT PRIMARY KEY AUTO_INCREMENT,
                report_name VARCHAR(100) NOT NULL,
                schedule_type ENUM('daily', 'weekly', 'monthly') NOT NULL,
                recipients TEXT,
                parameters JSON,
                last_run TIMESTAMP NULL,
                next_run TIMESTAMP NOT NULL,
                is_active BOOLEAN DEFAULT TRUE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ");
    }

    private function setupReportTemplates() {
        // Setup predefined report templates
        $templates = [
            'patient_demographics' => 'Patient Demographics Report',
            'appointment_utilization' => 'Appointment Utilization Report',
            'clinical_outcomes' => 'Clinical Outcomes Report',
            'billing_summary' => 'Billing Summary Report',
            'quality_measures' => 'Quality Measures Report'
        ];

        foreach ($templates as $key => $name) {
            $this->createReportTemplate($key, $name);
        }
    }

    private function createReportTemplate($key, $name) {
        sqlQuery("
            INSERT INTO report_templates (template_key, template_name, created_at)
            VALUES (?, ?, NOW())
        ", [$key, $name]);
    }
}

// Module Registry
class OpenEMRModuleRegistry {
    private $modules = [];

    public function registerModule($moduleClass) {
        $module = new $moduleClass();
        $this->modules[$module->moduleName] = $module;

        return $module;
    }

    public function getModule($name) {
        return $this->modules[$name] ?? null;
    }

    public function getAllModules() {
        return $this->modules;
    }

    public function installModule($name) {
        $module = $this->getModule($name);
        if ($module) {
            return $module->install();
        }

        return false;
    }

    public function uninstallModule($name) {
        $module = $this->getModule($name);
        if ($module) {
            return $module->uninstall();
        }

        return false;
    }
}

// Usage example
$registry = new OpenEMRModuleRegistry();

// Register custom modules
$telemedicineModule = $registry->registerModule(TelemedicineModule::class);
$reportingModule = $registry->registerModule(HealthcareReportingModule::class);

// Install modules
$registry->installModule('telemedicine');
$registry->installModule('healthcare_reporting');

// Get module information
$telemedicineInfo = $telemedicineModule->getModuleInfo();
echo "Installed module: " . $telemedicineInfo['name'] . " v" . $telemedicineInfo['version'];
?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="scripts.js"></script>
</body>
</html>
